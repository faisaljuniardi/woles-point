<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <title>Woles Point</title>
    <style>
        :root {
            --merah: #ff4d4d;
            --kuning: #ffde59;
            --hijau: #4caf50;
            --biru: #2196f3;
            --background: #f5f5f5;
            --card: #ffffff;
            --text: #333333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            color: white;
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
        }

        .description {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            background-color: #34495e;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            color: #ecf0f1;
            transition: background-color 0.3s;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab:hover {
            background-color: #2c3e50;
        }

        .tab.active {
            background-color: #1abc9c;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        .score-input input {
            width: 60px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        .score-input input::placeholder {
            color: #999;
            font-style: italic;
        }

        .score-input input:focus {
            border-color: #1abc9c;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 188, 156, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .team-merah {
            border-left: 4px solid var(--merah);
        }

        .team-kuning {
            border-left: 4px solid var(--kuning);
        }

        .team-hijau {
            border-left: 4px solid var(--hijau);
        }

        .team-biru {
            border-left: 4px solid var(--biru);
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-card {
            background-color: var(--card);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #1abc9c;
            outline: none;
            box-shadow: 0 0 5px rgba(26, 188, 156, 0.5);
        }

        button {
            background-color: #1abc9c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            display: inline-block;
            margin: 5px;
        }

        button:hover {
            background-color: #16a085;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-gk {
            background-color: #9b59b6;
        }

        .btn-gk:hover {
            background-color: #8e44ad;
        }

        .btn-export {
            background-color: #3498db;
        }

        .btn-export:hover {
            background-color: #2980b9;
        }

        .btn-excel {
            background-color: #27ae60;
        }

        .btn-excel:hover {
            background-color: #219955;
        }

        .ranking-badge {
            display: inline-block;
            width: 28px;
            height: 28px;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            line-height: 28px;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }

        .ranking-1 {
            background-color: gold;
            color: #333;
        }

        .ranking-2 {
            background-color: silver;
            color: #333;
        }

        .team-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .team-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .team-export-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            margin-bottom: 20px;
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .available-players {
            max-height: 75px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .team-players-list {
            min-height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .team-player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .team-player-item.gk-player {
            background: #e8f4fd;
            border-left: 4px solid #3498db;
            font-weight: bold;
        }

        .team-player-item:last-child {
            margin-bottom: 0;
        }

        .remove-player {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }

        .gk-badge {
            background-color: #9b59b6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .match-schedule {
            margin-top: 30px;
        }

        .match-schedule h3 {
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .match-card {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f9f9f9;
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .match-teams .team {
            display: flex;
            align-items: center;
        }

        .match-teams .score {
            font-size: 1.5rem;
            margin-left: 15px;
        }

        .team-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .dot-merah { background-color: var(--merah); }
        .dot-kuning { background-color: var(--kuning); }
        .dot-hijau { background-color: var(--hijau); }
        .dot-biru { background-color: var(--biru); }

        .schedule-and-standings {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }
        
        .cancel-penalty-container {
            margin-top: 10px;
            margin-bottom: 25px;
            padding: 15px;
            border: 2px dashed var(--merah);
            border-radius: 8px;
            background-color: #fffafa;
        }

        .reset-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #e74c3c;
            border-radius: 8px;
            background-color: #fff5f5;
            text-align: center;
        }

        .save-button-container {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .export-teams-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #3498db;
        }

        /* Footer Styles */
        .site-footer {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
        }
        
        .footer-content p {
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        @media (min-width: 768px) {
            .schedule-and-standings {
                grid-template-columns: 2fr 3fr;
            }
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
            }

            .player-list {
                grid-template-columns: 1fr;
            }

            .team-export-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Klasemen Poin Reward - Player Of The Month</h1>
            <p class="description">Sistem penghitungan poin dengan tie-breaker berdasarkan performa mingguan</p>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Klasemen</div>
            <div class="tab" onclick="switchTab('players')">Data Pemain</div>
            <div class="tab" onclick="switchTab('week1')">Minggu 1</div>
            <div class="tab" onclick="switchTab('week2')">Minggu 2</div>
            <div class="tab" onclick="switchTab('week3')">Minggu 3</div>
            <div class="tab" onclick="switchTab('week4')">Minggu 4</div>
        </div>

        <div id="dashboard" class="tab-content active">
            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="downloadRankingTable()">Unduh Klasemen (JPG)</button>
                <button class="btn-excel" onclick="exportToExcel()">Export to Excel</button>
            </div>
            <div id="ranking-combined-container" style="padding: 10px;">
                <h2>Klasemen Player Of The Month - Oktober</h2>
                <div style="overflow-x: auto;">
                    <table id="ranking-table">
                        <thead>
                            <tr>
                                <th>Peringkat</th>
                                <th>Nama Pemain</th>
                                <th>Total Poin</th>
                                <th>Minggu 1</th>
                                <th>Minggu 2</th>
                                <th>Minggu 3</th>
                                <th>Minggu 4</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; font-weight: bold; line-height: 1.8;">
                    <p>Reward:</p>
                    <p>- Winner: Jersey Custom</p>
                    <p>- Runner up: Gopay 25k</p>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <h3>Sistem Tie-Breaker:</h3>
                    <p>1. Total poin keseluruhan</p>
                    <p>2. Akumulasi poin minggu 1-3</p>
                    <p>3. Akumulasi poin minggu 1-2</p>
                    <p>4. Poin minggu 1</p>
                    <p>5. Urutan abjad</p>
                </div>
            </div>
        </div>

        <div id="players" class="tab-content">
            <h2>Data Pemain</h2>
            <div class="form-group">
                <label for="new-player">Tambah Pemain Baru:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-player" placeholder="Nama pemain">
                    <button id="add-player" onclick="addPlayer()">Tambah</button>
                </div>
            </div>

            <h3>Daftar Pemain</h3>
            <div class="player-list" id="players-list">
                <!-- Data akan diisi oleh JavaScript -->
            </div>
            
            <!-- Reset Section -->
            <div class="reset-section">
                <h3>Reset Data</h3>
                <p>Tombol ini akan mereset semua data poin, hasil mingguan, dan susunan pemain, tetapi tidak akan menghapus daftar nama pemain.</p>
                <button class="btn-danger" onclick="resetAllData()">Reset Semua Data</button>
            </div>
        </div>

        <div id="week1" class="tab-content">
            <h2>Data Minggu 1</h2>
            <div class="form-group">
                <label for="week1-date">Tanggal:</label>
                <input type="text" id="week1-date" placeholder="Tanggal">
            </div>

            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="downloadCombined(1)">Unduh Jadwal & Klasemen Tim (JPG)</button>
            </div>

            <div id="week1-combined" class="schedule-and-standings">
                <div>
                    <h3>Jadwal Pertandingan</h3>
                    <div id="week1-schedule"></div>
                </div>
                <div>
                    <h3>Klasemen Tim</h3>
                    <table id="week1-standings"></table>
                </div>
            </div>

            <!-- Container untuk export tim -->
            <div class="export-teams-container">
                <h3>Export Susunan Pemain Tim</h3>
                <p>Export susunan pemain untuk masing-masing tim dalam format JPG</p>
                <div class="team-export-container">
                    <button class="btn-export" onclick="exportAllTeams(1)">Export Semua Tim (4 Gambar)</button>
                    <button class="btn-export" onclick="exportTeam(1, 'merah')">Export Tim Merah</button>
                    <button class="btn-export" onclick="exportTeam(1, 'kuning')">Export Tim Kuning</button>
                    <button class="btn-export" onclick="exportTeam(1, 'hijau')">Export Tim Hijau</button>
                    <button class="btn-export" onclick="exportTeam(1, 'biru')">Export Tim Biru</button>
                </div>
            </div>

            <h3>Susun 4 Tim</h3>
            <div id="week1-teams">
                <!-- Data akan diisi oleh JavaScript -->
            </div>

            <div class="cancel-penalty-container">
                <h3>Pemain Cancel di Hari H</h3>
                <p style="color: var(--merah); margin-bottom: 10px; font-weight: bold;">Pemain yang cancel di hari H akan dikurangi 5 poin.</p>

                <div class="form-group">
                    <label>Tambah Pemain:</label>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Cari pemain..." onkeyup="filterCancelPlayers(1, this.value)">
                    </div>
                    <div class="available-players" id="available-cancel-players-1">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Daftar Pemain:</label>
                    <div class="team-players-list" id="canceled-players-1">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="save-btn" onclick="saveWeekData(1)">Simpan Data Minggu 1</button>
            </div>
        </div>

        <div id="week2" class="tab-content">
            <h2>Data Minggu 2</h2>
            <div class="form-group">
                <label for="week2-date">Tanggal:</label>
                <input type="text" id="week2-date" placeholder="Tanggal">
            </div>

            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="downloadCombined(2)">Unduh Jadwal & Klasemen Tim (JPG)</button>
            </div>

            <div id="week2-combined" class="schedule-and-standings">
                <div>
                    <h3>Jadwal Pertandingan</h3>
                    <div id="week2-schedule"></div>
                </div>
                <div>
                    <h3>Klasemen Tim</h3>
                    <table id="week2-standings"></table>
                </div>
            </div>

            <!-- Container untuk export tim -->
            <div class="export-teams-container">
                <h3>Export Susunan Pemain Tim</h3>
                <p>Export susunan pemain untuk masing-masing tim dalam format JPG</p>
                <div class="team-export-container">
                    <button class="btn-export" onclick="exportAllTeams(2)">Export Semua Tim (4 Gambar)</button>
                    <button class="btn-export" onclick="exportTeam(2, 'merah')">Export Tim Merah</button>
                    <button class="btn-export" onclick="exportTeam(2, 'kuning')">Export Tim Kuning</button>
                    <button class="btn-export" onclick="exportTeam(2, 'hijau')">Export Tim Hijau</button>
                    <button class="btn-export" onclick="exportTeam(2, 'biru')">Export Tim Biru</button>
                </div>
            </div>

            <h3>Susun 4 Tim</h3>
            <div id="week2-teams">
                <!-- Data akan diisi oleh JavaScript -->
            </div>

            <div class="cancel-penalty-container">
                <h3>Pemain Cancel di Hari H</h3>
                <p style="color: var(--merah); margin-bottom: 10px; font-weight: bold;">Pemain yang cancel di hari H akan dikurangi 5 poin.</p>

                <div class="form-group">
                    <label>Tambah Pemain:</label>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Cari pemain..." onkeyup="filterCancelPlayers(2, this.value)">
                    </div>
                    <div class="available-players" id="available-cancel-players-2">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Daftar Pemain:</label>
                    <div class="team-players-list" id="canceled-players-2">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="save-btn" onclick="saveWeekData(2)">Simpan Data Minggu 2</button>
            </div>
        </div>

        <div id="week3" class="tab-content">
            <h2>Data Minggu 3</h2>
            <div class="form-group">
                <label for="week3-date">Tanggal:</label>
                <input type="text" id="week3-date" placeholder="Tanggal">
            </div>

            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="downloadCombined(3)">Unduh Jadwal & Klasemen Tim (JPG)</button>
            </div>

            <div id="week3-combined" class="schedule-and-standings">
                <div>
                    <h3>Jadwal Pertandingan</h3>
                    <div id="week3-schedule"></div>
                </div>
                <div>
                    <h3>Klasemen Tim</h3>
                    <table id="week3-standings"></table>
                </div>
            </div>

            <!-- Container untuk export tim -->
            <div class="export-teams-container">
                <h3>Export Susunan Pemain Tim</h3>
                <p>Export susunan pemain untuk masing-masing tim dalam format JPG</p>
                <div class="team-export-container">
                    <button class="btn-export" onclick="exportAllTeams(3)">Export Semua Tim (4 Gambar)</button>
                    <button class="btn-export" onclick="exportTeam(3, 'merah')">Export Tim Merah</button>
                    <button class="btn-export" onclick="exportTeam(3, 'kuning')">Export Tim Kuning</button>
                    <button class="btn-export" onclick="exportTeam(3, 'hijau')">Export Tim Hijau</button>
                    <button class="btn-export" onclick="exportTeam(3, 'biru')">Export Tim Biru</button>
                </div>
            </div>

            <h3>Susun 4 Tim</h3>
            <div id="week3-teams">
                <!-- Data akan diisi oleh JavaScript -->
            </div>

            <div class="cancel-penalty-container">
                <h3>Pemain Cancel di Hari H</h3>
                <p style="color: var(--merah); margin-bottom: 10px; font-weight: bold;">Pemain yang cancel di hari H akan dikurangi 5 poin.</p>

                <div class="form-group">
                    <label>Tambah Pemain:</label>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Cari pemain..." onkeyup="filterCancelPlayers(3, this.value)">
                    </div>
                    <div class="available-players" id="available-cancel-players-3">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Daftar Pemain:</label>
                    <div class="team-players-list" id="canceled-players-3">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="save-btn" onclick="saveWeekData(3)">Simpan Data Minggu 3</button>
            </div>
        </div>

        <div id="week4" class="tab-content">
            <h2>Data Minggu 4</h2>
            <div class="form-group">
                <label for="week4-date">Tanggal:</label>
                <input type="text" id="week4-date" placeholder="Tanggal">
            </div>

            <div style="text-align: right; margin-bottom: 10px;">
                <button onclick="downloadCombined(4)">Unduh Jadwal & Klasemen Tim (JPG)</button>
            </div>

            <div id="week4-combined" class="schedule-and-standings">
                <div>
                    <h3>Jadwal Pertandingan</h3>
                    <div id="week4-schedule"></div>
                </div>
                <div>
                    <h3>Klasemen Tim</h3>
                    <table id="week4-standings"></table>
                </div>
            </div>

            <!-- Container untuk export tim -->
            <div class="export-teams-container">
                <h3>Export Susunan Pemain Tim</h3>
                <p>Export susunan pemain untuk masing-masing tim dalam format JPG</p>
                <div class="team-export-container">
                    <button class="btn-export" onclick="exportAllTeams(4)">Export Semua Tim (4 Gambar)</button>
                    <button class="btn-export" onclick="exportTeam(4, 'merah')">Export Tim Merah</button>
                    <button class="btn-export" onclick="exportTeam(4, 'kuning')">Export Tim Kuning</button>
                    <button class="btn-export" onclick="exportTeam(4, 'hijau')">Export Tim Hijau</button>
                    <button class="btn-export" onclick="exportTeam(4, 'biru')">Export Tim Biru</button>
                </div>
            </div>

            <h3>Susun 4 Tim</h3>
            <div id="week4-teams">
                <!-- Data akan diisi oleh JavaScript -->
            </div>

            <div class="cancel-penalty-container">
                <h3>Pemain Cancel di Hari H</h3>
                <p style="color: var(--merah); margin-bottom: 10px; font-weight: bold;">Pemain yang cancel di hari H akan dikurangi 5 poin.</p>

                <div class="form-group">
                    <label>Tambah Pemain:</label>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" placeholder="Cari pemain..." onkeyup="filterCancelPlayers(4, this.value)">
                    </div>
                    <div class="available-players" id="available-cancel-players-4">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Daftar Pemain:</label>
                    <div class="team-players-list" id="canceled-players-4">
                        <!-- Data akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
            <div class="save-button-container">
                <button class="save-btn" onclick="saveWeekData(4)">Simpan Data Minggu 4</button>
            </div>
        </div>
        <footer class="site-footer">
            <div class="footer-content">
                <p>&copy; 2025 Fjun21 </p>
                <p>Woles FC - Player Of The Month</p>
            </div>
        </footer>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Konfigurasi - GANTI URL INI DENGAN URL WEB APP ANDA
        const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywGTkiQEHPCWoxMpgP8LNppH2Mt625cAyeIh-HLJnenYZAdbwOHOlpin_kH63YcH0/exec';

        // Data awal
        let players = [];
        let weeksData = [{}, {}, {}, {}];
        let leaderboard = [];

        const teamColors = ['merah', 'kuning', 'hijau', 'biru'];
        const teamNames = {
            'merah': 'Tim Merah',
            'kuning': 'Tim Kuning', 
            'hijau': 'Tim Hijau',
            'biru': 'Tim Biru'
        };

        // Matchups for a 4-team round-robin
        const matchSchedule = [
            { team1: 'merah', team2: 'biru' },
            { team1: 'kuning', team2: 'hijau' },
            { team1: 'hijau', team2: 'merah' },
            { team1: 'biru', team2: 'kuning' },
            { team1: 'merah', team2: 'kuning' },
            { team1: 'hijau', team2: 'biru' }
        ];

        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
            renderPlayers();
            initializeWeeks();
            updateRanking();

            const today = new Date();
            const dateString = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth()+1).toString().padStart(2, '0')}/${today.getFullYear()}`;

            for (let i = 0; i < 4; i++) {
                if (!weeksData[i].date) {
                    document.getElementById(`week${i+1}-date`).value = dateString;
                }
            }
        });

        async function loadAllData() {
            showLoading();
            
            try {
                const result = await callGoogleAppsScript({ action: 'getAllData' });
                
                if (result.success) {
                    players = result.players || [];
                    weeksData = [
                        result.weeksData[1] || { date: '', teams: [], matches: [], cancelOnDay: [] },
                        result.weeksData[2] || { date: '', teams: [], matches: [], cancelOnDay: [] },
                        result.weeksData[3] || { date: '', teams: [], matches: [], cancelOnDay: [] },
                        result.weeksData[4] || { date: '', teams: [], matches: [], cancelOnDay: [] }
                    ];
                    
                    // Load leaderboard
                    await loadLeaderboard();
                } else {
                    alert('Error loading data: ' + result.error);
                }
            } catch (error) {
                alert('Error loading data from server');
            } finally {
                hideLoading();
            }
        }

        // Fungsi loading
        function showLoading() {
            if (!document.getElementById('loading')) {
                const loading = document.createElement('div');
                loading.id = 'loading';
                loading.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    color: white;
                    font-size: 18px;
                `;
                loading.innerHTML = 'Loading...';
                document.body.appendChild(loading);
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        // Fungsi untuk beralih tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const activeTabs = document.querySelectorAll(`.tab`);
            for (let tab of activeTabs) {
                if (tab.getAttribute('onclick') === `switchTab('${tabName}')`) {
                    tab.classList.add('active');
                    break;
                }
            }

            if (tabName.startsWith('week')) {
                const weekNum = parseInt(tabName.replace('week', ''));
                renderWeekData(weekNum);
            } else if (tabName === 'dashboard') {
                updateRanking();
            }
        }

        // Fungsi untuk merender daftar pemain
        function renderPlayers() {
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';

            players.sort();

            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.innerHTML = `
                    <span>${player}</span>
                    <button class="btn-small" onclick="removePlayer('${player}')">Hapus</button>
                `;
                playersList.appendChild(playerCard);
            });
        }

        // Fungsi untuk menambah pemain baru
        async function addPlayer() {
            const newPlayerInput = document.getElementById('new-player');
            const newPlayer = newPlayerInput.value.trim();

            if (newPlayer) {
                showLoading();
                const result = await callGoogleAppsScript({
                    action: 'addPlayer',
                    playerName: newPlayer
                });
                hideLoading();

                if (result.success) {
                    players.push(newPlayer);
                    players.sort();
                    renderPlayers();
                    newPlayerInput.value = '';
                    
                    for (let i = 1; i <= 4; i++) {
                        renderWeekData(i);
                    }
                    
                    alert(`Pemain ${newPlayer} berhasil ditambahkan!`);
                } else {
                    alert('Error: ' + result.error);
                }
            } else {
                alert('Nama pemain tidak boleh kosong!');
            }
        }

        // Fungsi untuk menghapus pemain
        async function removePlayer(playerName) {
            if (confirm(`Apakah Anda yakin ingin menghapus ${playerName}?`)) {
                showLoading();
                const result = await callGoogleAppsScript({
                    action: 'removePlayer', 
                    playerName: playerName
                });
                hideLoading();

                if (result.success) {
                    players = players.filter(p => p !== playerName);
                    renderPlayers();
                    
                    for (let i = 1; i <= 4; i++) {
                        renderWeekData(i);
                    }
                    
                    updateRanking();
                } else {
                    alert('Error: ' + result.error);
                }
            }
        }

        // Fungsi untuk inisialisasi data mingguan
        function initializeWeeks() {
            for (let i = 1; i <= 4; i++) {
                if (!weeksData[i-1].teams || weeksData[i-1].teams.length === 0) {
                    weeksData[i-1].teams = [];
                    for (let j = 0; j < 4; j++) {
                        weeksData[i-1].teams.push({
                            color: teamColors[j],
                            players: [],
                            gk: null,
                            wins: 0,
                            draws: 0,
                            losses: 0,
                            goalsFor: 0,
                            goalsAgainst: 0,
                            champion: false
                        });
                    }
                }

                if (!weeksData[i-1].matches || weeksData[i-1].matches.length === 0) {
                    weeksData[i-1].matches = matchSchedule.map(match => ({
                        ...match,
                        score1: null,
                        score2: null,
                        note: ''
                    }));
                }

                // Ensure cancelOnDay exists
                if (!weeksData[i-1].cancelOnDay) {
                    weeksData[i-1].cancelOnDay = [];
                }

                renderWeekData(i);
            }
        }

        // Fungsi untuk merender data mingguan
        function renderWeekData(weekNum) {
            const weekTeamsElement = document.getElementById(`week${weekNum}-teams`);
            const weekDateElement = document.getElementById(`week${weekNum}-date`);
            const weekScheduleElement = document.getElementById(`week${weekNum}-schedule`);
            const weekStandingsElement = document.getElementById(`week${weekNum}-standings`);

            // Elemen baru untuk Cancel Players
            const weekCancelPlayersAvailableElement = document.getElementById(`available-cancel-players-${weekNum}`);
            const weekCancelPlayersListElement = document.getElementById(`canceled-players-${weekNum}`);

            if (!weekTeamsElement) return;

            weekTeamsElement.innerHTML = '';

            // Format tanggal
            if (weeksData[weekNum - 1].date) {
                weekDateElement.value = weeksData[weekNum - 1].date;
            }

            
            // Render match schedule
            weekScheduleElement.innerHTML = weeksData[weekNum-1].matches.map((match, index) => {
                let displayScore1 = '';
                if (match.score1 !== null && match.score1 !== undefined) {
                    displayScore1 = match.score1.toString();
                }
                
                let displayScore2 = '';
                if (match.score2 !== null && match.score2 !== undefined) {
                    displayScore2 = match.score2.toString();
                }
                
                return `
                <div class="match-card">
                    <div class="match-teams">
                        <div class="team">
                            <span class="team-color-dot dot-${match.team1}"></span>
                            ${teamNames[match.team1]}
                        </div>
                        <div class="score-input">
                            <input type="text" pattern="[0-9]*" placeholder="-" value="${displayScore1}" onchange="updateMatchScore(${weekNum}, ${index}, 'score1', this.value)" onblur="validateScoreInput(this)" style="text-align: center;">
                        </div>
                    </div>
                    <div class="match-teams">
                        <div class="team">
                            <span class="team-color-dot dot-${match.team2}"></span>
                            ${teamNames[match.team2]}
                        </div>
                        <div class="score-input">
                            <input type="text" pattern="[0-9]*" placeholder="-" value="${displayScore2}" onchange="updateMatchScore(${weekNum}, ${index}, 'score2', this.value)" onblur="validateScoreInput(this)" style="text-align: center;">
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Render team standings
            const standings = calculateStandings(weeksData[weekNum - 1]);
            weekStandingsElement.innerHTML = `
                <thead>
                    <tr>
                        <th>P</th>
                        <th>W</th>
                        <th>D</th>
                        <th>L</th>
                        <th>GF</th>
                        <th>GA</th>
                        <th>GD</th>
                        <th>PTS</th>
                    </tr>
                </thead>
                <tbody>
                    ${standings.map(team => `
                        <tr class="team-${team.color}">
                            <td>${team.played}</td>
                            <td>${team.wins}</td>
                            <td>${team.draws}</td>
                            <td>${team.losses}</td>
                            <td>${team.goalsFor}</td>
                            <td>${team.goalsAgainst}</td>
                            <td>${team.goalDifference}</td>
                            <td>${team.points}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            // Render Susun 4 Tim dengan desain baru
            weeksData[weekNum-1].teams.forEach((team, index) => {
                const teamSection = document.createElement('div');
                teamSection.className = `team-section team-${team.color}`;

                const allPlayersInTeams = weeksData[weekNum-1].teams.flatMap(t => t.players);
                const availablePlayers = players.filter(p => !allPlayersInTeams.includes(p) || team.players.includes(p));

                teamSection.innerHTML = `
                    <div class="team-header">
                        <div class="team-title">${teamNames[team.color]}</div>
                    </div>

                    <div class="form-group">
                        <label>Tambah Pemain:</label>
                        <div class="search-box">
                            <span class="search-icon">🔍</span>
                            <input type="text" placeholder="Cari pemain..." onkeyup="filterPlayers(${weekNum}, '${team.color}', this.value)">
                        </div>
                        <div class="available-players" id="available-${weekNum}-${team.color}">
                            ${availablePlayers.map(player => {
                                const isGK = team.gk === player;
                                return `
                                <div class="player-item">
                                    <span>${player} ${isGK ? '<span class="gk-badge">GK</span>' : ''}</span>
                                    <div>
                                        ${!team.players.includes(player) ? 
                                            `<button class="btn-small" onclick="addPlayerToTeam(${weekNum}, '${team.color}', '${player}')">Tambahkan</button>` : 
                                            `<button class="btn-small btn-gk" onclick="setAsGK(${weekNum}, '${team.color}', '${player}')">Jadikan GK</button>`
                                        }
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pemain dalam Tim:</label>
                        <div class="team-players-list" id="players-${weekNum}-${team.color}">
                            ${team.players.length > 0 ? 
                                team.players.sort((a, b) => {
                                    if (a === team.gk) return -1;
                                    if (b === team.gk) return 1;
                                    return 0;
                                }).map(player => {
                                    const isGK = team.gk === player;
                                    return `
                                    <div class="team-player-item ${isGK ? 'gk-player' : ''}">
                                        <span>${player} ${isGK ? '<span class="gk-badge">GK</span>' : ''}</span>
                                        <div>
                                           <span class="remove-player" onclick="removePlayerFromTeam(${weekNum}, '${team.color}', '${player}')">✕</span>
                                        </div>
                                    </div>
                                `}).join('') : 
                                '<p style="text-align: center; color: #999;">Belum ada pemain</p>'
                            }
                        </div>
                    </div>
                `;

                weekTeamsElement.appendChild(teamSection);
            });

            // Render Cancel Players
            const allPlayersInTeams = weeksData[weekNum-1].teams.flatMap(t => t.players);
            const allCancelPlayers = weeksData[weekNum-1].cancelOnDay || [];
            const availableCancelPlayers = players.filter(p => !allCancelPlayers.includes(p));

            weekCancelPlayersAvailableElement.innerHTML = availableCancelPlayers.map(player => `
                <div class="player-item">
                    <span>${player}</span>
                    <button class="btn-small" onclick="addCancelPlayer(${weekNum}, '${player}')">Tambahkan</button>
                </div>
            `).join('');

            weekCancelPlayersListElement.innerHTML = allCancelPlayers.length > 0 ? allCancelPlayers.map(player => `
                <div class="team-player-item">
                    <span>${player}</span>
                    <span class="remove-player" onclick="removeCancelPlayer(${weekNum}, '${player}')">✕</span>
                </div>
            `).join('') : '<p style="text-align: center; color: #999;">Belum ada pemain</p>';
        }

        // Fungsi untuk filter pemain yang tersedia
        function filterPlayers(weekNum, teamColor, searchTerm) {
            const allPlayersInTeams = weeksData[weekNum-1].teams.flatMap(t => t.players);
            const team = weeksData[weekNum-1].teams.find(t => t.color === teamColor);
            const availablePlayers = players.filter(p => !allPlayersInTeams.includes(p) || team.players.includes(p));

            const filteredPlayers = availablePlayers.filter(player => 
                player.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const availableElement = document.getElementById(`available-${weekNum}-${teamColor}`);
            availableElement.innerHTML = filteredPlayers.map(player => {
                const isGK = team.gk === player;
                return `
                <div class="player-item">
                    <span>${player} ${isGK ? '<span class="gk-badge">GK</span>' : ''}</span>
                    <div>
                        ${!team.players.includes(player) ? 
                            `<button class="btn-small" onclick="addPlayerToTeam(${weekNum}, '${team.color}', '${player}')">Tambahkan</button>` : 
                            `<button class="btn-small btn-gk" onclick="setAsGK(${weekNum}, '${team.color}', '${player}')">Jadikan GK</button>`
                        }
                    </div>
                </div>
            `}).join('');
        }

        // Fungsi untuk filter pemain cancel
        function filterCancelPlayers(weekNum, searchTerm) {
            const allPlayersInTeams = weeksData[weekNum-1].teams.flatMap(t => t.players);
            const allCancelPlayers = weeksData[weekNum-1].cancelOnDay || [];
            const availableCancelPlayers = players.filter(p => !allCancelPlayers.includes(p));

            const filteredPlayers = availableCancelPlayers.filter(player => 
                player.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const availableElement = document.getElementById(`available-cancel-players-${weekNum}`);
            availableElement.innerHTML = filteredPlayers.map(player => `
                <div class="player-item">
                    <span>${player}</span>
                    <button class="btn-small" onclick="addCancelPlayer(${weekNum}, '${player}')">Tambahkan</button>
                </div>
            `).join('');
        }

        // Fungsi untuk menambahkan pemain ke tim
        function addPlayerToTeam(weekNum, teamColor, playerName) {
            const team = weeksData[weekNum-1].teams.find(t => t.color === teamColor);
            if (team && !team.players.includes(playerName)) {
                team.players.push(playerName);
                updateTeamResults(weeksData[weekNum-1]);
                renderWeekData(weekNum);
                updateRanking();
            }
        }

        // Fungsi untuk menghapus pemain dari tim
        function removePlayerFromTeam(weekNum, teamColor, playerName) {
            const team = weeksData[weekNum-1].teams.find(t => t.color === teamColor);
            if (team) {
                team.players = team.players.filter(p => p !== playerName);
                if (team.gk === playerName) {
                    team.gk = null;
                }
                updateTeamResults(weeksData[weekNum-1]);
                renderWeekData(weekNum);
                updateRanking();
            }
        }

        // Fungsi untuk menambahkan pemain cancel
        function addCancelPlayer(weekNum, playerName) {
            if (!weeksData[weekNum-1].cancelOnDay.includes(playerName)) {
                weeksData[weekNum-1].cancelOnDay.push(playerName);
                renderWeekData(weekNum);
                updateRanking();
            }
        }

        // Fungsi untuk menghapus pemain cancel
        function removeCancelPlayer(weekNum, playerName) {
            weeksData[weekNum-1].cancelOnDay = weeksData[weekNum-1].cancelOnDay.filter(p => p !== playerName);
            renderWeekData(weekNum);
            updateRanking();
        }

        // Fungsi untuk memperbarui skor pertandingan
        function updateMatchScore(weekNum, matchIndex, scoreType, value) {
            if (value === '' || value === '-' || value === null || value === undefined) {
                weeksData[weekNum-1].matches[matchIndex][scoreType] = null;
            } else {
                const numericValue = parseInt(value);
                if (isNaN(numericValue)) {
                    weeksData[weekNum-1].matches[matchIndex][scoreType] = null;
                } else {
                    weeksData[weekNum-1].matches[matchIndex][scoreType] = numericValue;
                }
            }
            
            updateTeamResults(weeksData[weekNum-1]);
            renderWeekData(weekNum);
            updateRanking();
        }

        // Fungsi untuk menjadikan pemain sebagai GK
        function setAsGK(weekNum, teamColor, playerName) {
            const team = weeksData[weekNum-1].teams.find(t => t.color === teamColor);
            if (team && team.players.includes(playerName)) {
                team.gk = playerName;
                renderWeekData(weekNum);
            }
        }

        // Fungsi untuk menghitung dan mengupdate hasil tim berdasarkan skor pertandingan
        function updateTeamResults(week) {
            week.teams.forEach(team => {
                team.wins = 0;
                team.draws = 0;
                team.losses = 0;
                team.goalsFor = 0;
                team.goalsAgainst = 0;
            });

            week.matches.forEach(match => {
                const team1 = week.teams.find(t => t.color === match.team1);
                const team2 = week.teams.find(t => t.color === match.team2);

                if (team1 && team2 && match.score1 !== null && match.score1 !== undefined && match.score2 !== null && match.score2 !== undefined) {
                    team1.goalsFor += match.score1;
                    team1.goalsAgainst += match.score2;
                    team2.goalsFor += match.score2;
                    team2.goalsAgainst += match.score1;

                    if (match.score1 > match.score2) {
                        team1.wins++;
                        team2.losses++;
                    } else if (match.score1 < match.score2) {
                        team1.losses++;
                        team2.wins++;
                    } else {
                        team1.draws++;
                        team2.draws++;
                    }
                }
            });
        }

        // Fungsi untuk menghitung klasemen
        function calculateStandings(weekData) {
            const standings = weekData.teams.map(team => ({
                color: team.color,
                played: team.wins + team.draws + team.losses,
                wins: team.wins,
                draws: team.draws,
                losses: team.losses,
                goalsFor: team.goalsFor,
                goalsAgainst: team.goalsAgainst,
                goalDifference: team.goalsFor - team.goalsAgainst,
                points: (team.wins * 3) + (team.draws * 1)
            }));

            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });

            return standings;
        }

        // MODIFIKASI: Update fungsi updateRanking dengan tie-breaker berdasarkan akumulasi
        async function updateRanking() {
            console.log('Starting updateRanking...');
            const rankingTable = document.getElementById('ranking-table');
            if (!rankingTable) {
                console.error('Ranking table element not found');
                return;
            }

            const tbody = rankingTable.querySelector('tbody');
            tbody.innerHTML = '';

            const playerPoints = {};
            players.forEach(player => {
                playerPoints[player] = {
                    total: 0,
                    week1: 0,
                    week2: 0,
                    week3: 0,
                    week4: 0
                };
            });

            console.log('Calculating points for', players.length, 'players');

            // Hitung poin untuk setiap minggu
            for (let weekIndex = 0; weekIndex < 4; weekIndex++) {
                const weekData = weeksData[weekIndex];
                const weekKey = `week${weekIndex + 1}`;

                if (weekData.teams && weekData.teams.length > 0) {
                    const standings = calculateStandings(weekData);
                    const championTeamColor = standings.length > 0 ? standings[0].color : null;

                    weekData.teams.forEach(team => {
                        const isChampion = team.color === championTeamColor;
                        
                        team.players.forEach(player => {
                            if (playerPoints[player]) {
                                let weeklyPoints = 0;
                                
                                // Poin kehadiran
                                weeklyPoints += 3;
                                
                                // Poin hasil pertandingan
                                weeklyPoints += (team.wins * 3);
                                weeklyPoints += (team.draws * 1);
                                
                                // Poin juara
                                if (isChampion) {
                                    weeklyPoints += 2;
                                }
                                
                                playerPoints[player][weekKey] = weeklyPoints;
                                playerPoints[player].total += weeklyPoints;
                            }
                        });
                    });

                    // Pengurangan untuk pemain cancel
                    if (weekData.cancelOnDay) {
                        weekData.cancelOnDay.forEach(player => {
                            if (playerPoints[player]) {
                                playerPoints[player][weekKey] -= 5;
                                playerPoints[player].total -= 5;
                            }
                        });
                    }
                }
            }

            // Konversi ke array untuk sorting dengan tie-breaker
            const rankingArray = Object.keys(playerPoints).map(playerName => ({
                name: playerName,
                total: playerPoints[playerName].total,
                weeks: [
                    playerPoints[playerName].week1,
                    playerPoints[playerName].week2,
                    playerPoints[playerName].week3,
                    playerPoints[playerName].week4
                ]
            }));

            // Urutkan dengan tie-breaker berdasarkan akumulasi
            rankingArray.sort((a, b) => {
                // 1. Bandingkan total poin (descending)
                if (b.total !== a.total) {
                    return b.total - a.total;
                }
                
                // 2. Jika total sama, bandingkan akumulasi minggu 1-3 (total tanpa minggu 4)
                const totalWeek1to3_A = a.weeks[0] + a.weeks[1] + a.weeks[2];
                const totalWeek1to3_B = b.weeks[0] + b.weeks[1] + b.weeks[2];
                if (totalWeek1to3_B !== totalWeek1to3_A) {
                    return totalWeek1to3_B - totalWeek1to3_A;
                }
                
                // 3. Jika masih sama, bandingkan akumulasi minggu 1-2
                const totalWeek1to2_A = a.weeks[0] + a.weeks[1];
                const totalWeek1to2_B = b.weeks[0] + b.weeks[1];
                if (totalWeek1to2_B !== totalWeek1to2_A) {
                    return totalWeek1to2_B - totalWeek1to2_A;
                }
                
                // 4. Jika masih sama, bandingkan poin minggu 1
                if (b.weeks[0] !== a.weeks[0]) {
                    return b.weeks[0] - a.weeks[0];
                }
                
                // 5. Jika semua sama, bandingkan berdasarkan abjad (ascending)
                return a.name.localeCompare(b.name);
            });

            console.log('Ranking array with tie-breakers:', rankingArray);

            // Simpan ke leaderboard array
            leaderboard = rankingArray.map((player, index) => ({
                rank: index + 1,
                playerName: player.name,
                totalPoints: player.total,
                week1: player.weeks[0] || 0,
                week2: player.weeks[1] || 0,
                week3: player.weeks[2] || 0,
                week4: player.weeks[3] || 0
            }));

            console.log('Leaderboard data to save:', leaderboard);

            // Render tabel
            rankingArray.forEach((player, index) => {
                const row = document.createElement('tr');

                let rankClass = '';
                if (index === 0) rankClass = 'ranking-1';
                else if (index === 1) rankClass = 'ranking-2';

                const playerNameDisplay = (index === 0 || index === 1) ? `<strong>${player.name}</strong>` : player.name;

                row.innerHTML = `
                    <td><span class="ranking-badge ${rankClass}">${index + 1}</span></td>
                    <td>${playerNameDisplay}</td>
                    <td><strong>${player.total}</strong></td>
                    <td>${player.weeks[0] || 0}</td>
                    <td>${player.weeks[1] || 0}</td>
                    <td>${player.weeks[2] || 0}</td>
                    <td>${player.weeks[3] || 0}</td>
                `;

                tbody.appendChild(row);
            });

            // Simpan leaderboard ke Google Sheets
            const saveResult = await saveLeaderboardToSheets();
            console.log('Save leaderboard result:', saveResult);
        }

        async function saveLeaderboardToSheets() {
            try {
                console.log('Saving leaderboard to sheets...', leaderboard);
                
                if (!leaderboard || leaderboard.length === 0) {
                    console.warn('No leaderboard data to save');
                    return { success: false, error: 'No data' };
                }

                const result = await callGoogleAppsScript({
                    action: 'updateLeaderboard',
                    leaderboardData: JSON.stringify(leaderboard)
                });
                
                console.log('Save leaderboard API response:', result);
                
                if (result.success) {
                    console.log('✅ Leaderboard saved successfully to Google Sheets');
                    return { success: true };
                } else {
                    console.error('❌ Error saving leaderboard:', result.error);
                    return { success: false, error: result.error };
                }
            } catch (error) {
                console.error('❌ Exception saving leaderboard:', error);
                return { success: false, error: error.message };
            }
        }

        async function saveWeekData(weekNum) {
            weeksData[weekNum-1].date = document.getElementById(`week${weekNum}-date`).value;
            
            showLoading();
            const result = await callGoogleAppsScript({
                action: 'saveWeekData',
                weekNum: weekNum,
                weekData: JSON.stringify(weeksData[weekNum-1])
            });
            hideLoading();

            if (result.success) {
                updateRanking();
                alert(`Data minggu ${weekNum} berhasil disimpan!`);
            } else {
                alert('Error saving data: ' + result.error);
            }
        }

        // Fungsi untuk memanggil Google Apps Script
        async function callGoogleAppsScript(params) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const response = await fetch(`${APPSCRIPT_URL}?${queryString}`);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error calling Google Apps Script:', error);
                return { success: false, error: error.message };
            }
        }

        // Fungsi untuk mengunduh gambar dari elemen HTML
        function downloadAsImage(elementId, filename) {
            const element = document.getElementById(elementId);
            html2canvas(element, { 
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        // Fungsi untuk mengunduh jadwal dan klasemen tim
        function downloadCombined(weekNum) {
            const element = document.getElementById(`week${weekNum}-combined`);
            const date = document.getElementById(`week${weekNum}-date`).value || `Minggu-${weekNum}`;
            html2canvas(element, { 
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Jadwal-Klasemen-Minggu-${weekNum}-${date.replace(/\//g, '-')}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        // Fungsi untuk mengunduh tabel klasemen
        function downloadRankingTable() {
            const element = document.getElementById('ranking-combined-container');
            html2canvas(element, { 
                scale: 2,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Klasemen-Player-Of-The-Month.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        // FUNGSI BARU: Export susunan pemain tim yang FIXED
        function exportTeam(weekNum, teamColor) {
            const team = weeksData[weekNum-1].teams.find(t => t.color === teamColor);
            if (!team || team.players.length === 0) {
                alert(`Tim ${teamNames[teamColor]} belum memiliki pemain!`);
                return;
            }

            const exportContainer = document.createElement('div');
            exportContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 400px;
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 0 30px rgba(0,0,0,0.4);
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                transform: translate(-100%, -100%);
            `;

            const borderColors = {
                'merah': '#ff4d4d',
                'kuning': '#ffde59', 
                'hijau': '#4caf50',
                'biru': '#2196f3'
            };

            exportContainer.style.border = `5px solid ${borderColors[teamColor]}`;

            const date = document.getElementById(`week${weekNum}-date`).value || `Minggu-${weekNum}`;
            
            exportContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: ${borderColors[teamColor]}; margin: 0 0 8px 0; font-size: 26px; font-weight: bold;">${teamNames[teamColor]}</h2>
                    <p style="margin: 0; color: #666; font-size: 16px; font-weight: 500;">Minggu ${weekNum} - ${date}</p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                    <h3 style="margin: 0 0 18px 0; color: #2c3e50; font-size: 20px; text-align: center; font-weight: bold;">SUSUNAN PEMAIN</h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${team.players.map((player, index) => `
                            <li style="padding: 12px 15px; border-bottom: ${index < team.players.length - 1 ? '2px solid #dee2e6' : 'none'}; 
                                      display: flex; justify-content: space-between; align-items: center;
                                      ${team.gk === player ? 'background: linear-gradient(135deg, #e8f4fd, #d4edfa); font-weight: bold; border-left: 4px solid #3498db;' : 'background: white;'}
                                      font-size: 16px; margin-bottom: ${index < team.players.length - 1 ? '8px' : '0'}; border-radius: 6px;">
                                <span style="${team.gk === player ? 'color: #2c3e50;' : 'color: #495057;'}">${player}</span>
                                ${team.gk === player ? '<span style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">GOALKEEPER</span>' : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                <div style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 12px; font-style: italic;">
                    Woles Point System - Player Of The Month
                </div>
            `;

            document.body.appendChild(exportContainer);

            html2canvas(exportContainer, {
                scale: 3,
                useCORS: true,
                allowTaint: false,
                backgroundColor: '#ffffff',
                logging: false,
                width: exportContainer.offsetWidth,
                height: exportContainer.offsetHeight,
                onclone: function(clonedDoc) {
                    const clonedElement = clonedDoc.querySelector('[style*="z-index: 10000"]');
                    if (clonedElement) {
                        clonedElement.style.transform = 'translate(0, 0)';
                    }
                }
            }).then(canvas => {
                try {
                    const dataURL = canvas.toDataURL('image/jpeg', 0.95);
                    const link = document.createElement('a');
                    link.download = `${teamNames[teamColor]}-Minggu-${weekNum}-${date.replace(/\//g, '-')}.jpg`;
                    link.href = dataURL;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    document.body.removeChild(exportContainer);
                    
                    console.log('Export berhasil:', link.download);
                    
                } catch (error) {
                    console.error('Error dalam export:', error);
                    alert('Terjadi error saat mengexport. Silakan coba lagi.');
                    document.body.removeChild(exportContainer);
                }
            }).catch(error => {
                console.error('Error html2canvas:', error);
                alert('Terjadi error saat konversi ke gambar.');
                document.body.removeChild(exportContainer);
            });
        }

        // FUNGSI BARU: Export semua tim sekaligus yang FIXED
        function exportAllTeams(weekNum) {
            const teamsWithPlayers = teamColors.filter(color => {
                const team = weeksData[weekNum-1].teams.find(t => t.color === color);
                return team && team.players.length > 0;
            });

            if (teamsWithPlayers.length === 0) {
                alert('Tidak ada tim yang memiliki pemain!');
                return;
            }

            let exportedCount = 0;
            
            teamsWithPlayers.forEach((teamColor, index) => {
                setTimeout(() => {
                    exportTeam(weekNum, teamColor);
                    exportedCount++;
                    
                    if (exportedCount === teamsWithPlayers.length) {
                        setTimeout(() => {
                            alert(`Berhasil mengexport ${exportedCount} tim! File akan terdownload satu per satu.`);
                        }, 1000);
                    }
                }, index * 2000);
            });
        }

        // MODIFIKASI: Update fungsi resetAllData untuk reset leaderboard juga
        async function resetAllData() {
            if (confirm("Apakah Anda yakin ingin mereset semua data poin, hasil mingguan, dan susunan pemain? Nama-nama pemain tidak akan dihapus.")) {
                showLoading();
                
                for (let i = 1; i <= 4; i++) {
                    weeksData[i-1] = {
                        date: '',
                        teams: [],
                        matches: [],
                        cancelOnDay: []
                    };
                    
                    for (let j = 0; j < 4; j++) {
                        weeksData[i-1].teams.push({
                            color: teamColors[j],
                            players: [],
                            gk: null,
                            wins: 0,
                            draws: 0,
                            losses: 0,
                            goalsFor: 0,
                            goalsAgainst: 0,
                            champion: false
                        });
                    }
                    
                    weeksData[i-1].matches = matchSchedule.map(match => ({
                        ...match,
                        score1: null,
                        score2: null,
                        note: ''
                    }));
                    
                    const result = await callGoogleAppsScript({
                        action: 'saveWeekData',
                        weekNum: i,
                        weekData: JSON.stringify(weeksData[i-1])
                    });
                    
                    if (!result.success) {
                        alert(`Error resetting week ${i}: ` + result.error);
                    }
                }
                
                // Reset leaderboard
                leaderboard = [];
                await saveLeaderboardToSheets();
                
                hideLoading();
                
                for (let i = 1; i <= 4; i++) {
                    renderWeekData(i);
                }
                
                updateRanking();
                
                alert("Semua data poin, hasil mingguan, dan susunan pemain telah direset!");
            }
        }

        // FUNGSI BARU: Export to Excel
        function exportToExcel() {
            const data = [];
            
            data.push(['Klasemen Player Of The Month']);
            data.push(['Periode: Oktober 2025']);
            data.push([]);
            data.push(['Peringkat', 'Nama Pemain', 'Total Poin', 'Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4']);
            
            const table = document.getElementById('ranking-table');
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                const rankText = cells[0].textContent.trim();
                rowData.push(rankText);
                
                for (let i = 1; i < cells.length; i++) {
                    rowData.push(cells[i].textContent.trim());
                }
                
                data.push(rowData);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            const colWidths = [
                { wch: 10 },
                { wch: 25 },
                { wch: 12 },
                { wch: 10 },
                { wch: 10 },
                { wch: 10 },
                { wch: 10 }
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Klasemen');
            
            XLSX.writeFile(wb, `Klasemen_POTM_Oktober_2025.xlsx`);
        }

        // Fungsi validasi input score
        function validateScoreInput(input) {
            if (input.value === '' || input.value === '-') {
                input.value = '';
            } else if (!/^\d+$/.test(input.value)) {
                input.value = '';
                alert('Masukkan angka yang valid!');
            }
        }

        // Fungsi untuk load leaderboard dari Google Sheets
        async function loadLeaderboard() {
            try {
                const result = await callGoogleAppsScript({ action: 'getLeaderboard' });
                
                if (result.success) {
                    leaderboard = result.leaderboard;
                    return true;
                } else {
                    console.error('Error loading leaderboard:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Error loading leaderboard from sheets:', error);
                return false;
            }
        }
    </script>
</body>
</html>